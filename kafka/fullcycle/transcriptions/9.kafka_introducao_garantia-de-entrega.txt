Olá pessoal, tudo bem? A gente já entendeu a ideia básica sobre um tópico, sobre as partições, sobre as keys, a anatomia de um tópico, como que as partições são distribuídas, leaders, followers e etc. Mas agora a gente vai começar a entrar nos detalhes em relação a como que um producer manda uma mensagem e como que eu consigo garantir que realmente essa mensagem foi entregue. Eu não sei se já tinha passado isso pela sua cabeça, mas Como que eu garanto? Como que eu tenho certeza que aquela minha mensagem foi entregue? Então, mais uma vez, você vai ver aí as mentes brilhantes, vamos dizer assim, dos caras que criaram essa solução e pensaram aí nessas situações. Então vamos fazer o seguinte. Producer. Vamos falar dos producers agora, na garantia de entrega. Então vamos lá. Seguinte, eu tenho um producer, eu tenho o broker A, eu tenho o broker B e eu tenho o broker C. Legal? Então o que que acontece? O broker A, lembra, ele é o líder e a gente tem o follower, né? Então nesse broker aqui eu tenho aquelas partições, né? E ali eu tenho a líder e os meus dois followers aí. Aí o que que acontece? Eu mando uma mensagem. E aí, essa mensagem ela vai cair pra quem? sempre para o nosso líder também. Eu falei que era sempre consumido do líder, mas também é sempre entregue ao líder a mensagem. Então o que acontece? Na hora que o produtor vai enviar essa mensagem, ele vai poder setar um parâmetro. E um desses parâmetros é o ACK 0. ACK significa de Acknowledgement. Acknowledge é quando você fala, opa, você tem que falar que tá tudo em ordem. Então quando eu tô falando isso pra ele, eu tô falando o seguinte, o ACK é 0. O que isso significa? Não. Eu tô dizendo o seguinte, toda vez que eu mandar uma mensagem, eu mando e você nem precisa me retornar falando que deu certo que a mensagem chegou isso aí normalmente a gente chama também de ff tá fire and forget ou seja você dispara e esquece Wesley, mas isso não é um pouco arriscado? Eu falo sim, é arriscado. Porque eu não posso garantir o meu producer, ele não recebe a confirmação ali do Kafka, falando que olha, gravei a mensagem, tá tudo ok. Por outro lado, se o Kafka não tem que ficar notificando o producer toda hora, o que acontece aí nesse caso? O Kafka consegue processar mais mensagem. Então por um lado, A gente não tem essa certeza que o Kafka conseguiu salvar a mensagem. O que a gente tem certeza é que você consegue mandar muito mais mensagem. Porque o Kafka não tem que ficar guardando, avisando, guardando, avisando. Ele só vai guardando. Legal? Wesley, mas eu posso perder mensagem. Pode. E aí vai depender do seu contexto. Vou dar um exemplo aqui pra você e eu não tô dizendo que é assim. Vamos imaginar que eu trabalho no Uber. E eu tenho um motorista que fica andando e ele a cada 10 segundos ele fica mandando as posições aonde ele tá. Adivinha o que o Uber usa, né? Pra mandar informações e etc. Cai tudo no Kafka. Você acha que seria algo muito drástico pro negócio do Uber caso a informação desse GPS de algumas vezes não aparecer? Tipo, o carro tava andando, passou 10 segundos, daí perdeu a mensagem, depois 10 segundos a mensagem chegou, então o que que isso significa? Eu consigo mandar um monte de mensagem e eu assumo risco se perder uma ou outra, não vai matar o meu negócio. Entende? Por outro lado, não vai matar meu negócio, mas eu consigo processar muito mais mensagem. Então, quando eu estou disposto e ciente que eu posso perder uma mensagem, eu vou trabalhar dessa forma. E por isso que eu acho importante, galera, todo esse embasamento teórico que eu tô dando pra você, porque tem muita gente hoje em dia, infelizmente, que sai utilizando Kafka e não sabe nem qual o tipo de garantia de entrega que ele tá tendo. porque ele entende esses conceitos. Então fica muito ligado nisso. Então vamos lá. Essa é a primeira versão. A gente tem uma outra versão que é o seguinte. Eu mando a mensagem e eu tenho o EC1. O que isso significa? Significa LEADER. Como assim Wesley? Significa o seguinte. Eu mando a mensagem Aí a mensagem bate lá no líder, o líder salva a mensagem e envia uma resposta pro producer falando, ó, salvei a mensagem, ok? Nossa Wesley, mas tá bom essa história, né? Tá muito bem, tá muito bacana essa história. Esse é o ambiente ideal? Depende, olha só o que pode acontecer, né? São aquelas coisas que a gente tem que ficar maquinando mesmo para garantir resiliência ao limite. Vamos imaginar que o broker A mandou, o produtor mandou a mensagem para o broker A, o broker A realmente salvou a mensagem e enviou a confirmação para o producer, mas logo que isso aconteceu, ele caiu. A máquina morreu, a HD queimou. O que acontece? O broker A ainda não tinha tempo, não teve tempo de replicar essa mensagem para os followers. Então, houve perda de mensagem. E o pior, O producer acreditou ainda que essa mensagem foi guardada, mas no final das contas ela foi perdida porque o broker caiu antes de replicar essa mensagem. Bom, já deve dar pra você perceber que quando começo a mandar mensagem e ter que aguardar uma confirmação, ter um evento de confirmação que a mensagem foi guardada, provavelmente já deu pra você se ligar que a velocidade de todo esse processo acaba ficando um pouco mais lento do que eu não ter que mandar nenhuma confirmação. Mas ainda assim, você tem a garantia de entrega em algum momento. Agora Wesley, eu não posso perder, eu não posso nem ter essa chance ínfima dessa situação que a gente acabou de falar. Então a gente tem essa terceira opção, que é o EC-1, que significa ALL. O que isso significa? Significa que o producer vai mandar a mensagem, vai bater no leader, o leader vai salvar. Aí o leader vai replicar essas mensagens nos followers, Os followers vão avisar o líder que as mensagens foram salvas. Aí sim, o líder vai avisar o producer que a mensagem foi salva. E aí não tem problema mesmo, porque daí a mensagem foi replicada. Então se o broker morrer nesse momento, tem problema que a mensagem já tem cópia. Nesse caso, eu estou querendo ter uma garantia total de que a mensagem foi replicada. Salva e replicada. E nesse caso eu tenho paz de espírito e tenho certeza que tudo que eu mandei tá guardadinho lá. O problema é que já deu pra perceber que a parada é muito mais lenta. Muito mesmo. Por quê? Porque além do líder ter que salvar e voltar a avisar, ele tem que salvar, replicar, aguardar a resposta dos followers falando que foi replicado, pra daí ele avisar o producer. Então é um caminho muito mais longo, tem muito menos performance, mas 100% de garantia. Então o Kafka aí nesse caso ele tá pra todos os gostos aí pra gente. Porque no final das contas você tem até o cara que pode perder uma mensagem, o cara que quer ter uma garantia mínima e um cara que quer ter 100% das garantias. Kafka pra todos os gostos e assim você tem um pouco mais de noção e consegue agora saber quando que você vai aplicar cada momento quando você for trabalhar com garantia de entrega de mensagens pelos producers. Show de bola? Então é isso aí. Tem mais pra gente falar aí pra frente sobre produção de mensagens no Kafka. Vamos nessa! Olá pessoal, tudo bem? Agora eu quero continuar falando um pouquinho de garantia de entregas de mensagens, porém, mas são alguns outros detalhes que a gente acaba tendo, inclusive para o Kafka conseguir se comportar da melhor forma que você quer e tendo também aquele custo-benefício em relação à performance versus garantias que o Kafka pode dar pra gente. Então vamos lá, vamos falar um pouco mais sobre algumas garantias que a gente que a gente pode trabalhar com o Kafka é chamada de At Most Once. O que significa isso? É uma melhor performance que ele vai ter, porém ele pode perder no meio da história algumas mensagens. Então o que acontece? pelo menos ele pode receber essa mensagem mas pode ser que alguma ali pode se perder no meio olha só que negócio estranho eu tenho o Kafka eu tenho mensagem 1, 2, 3, 4, 5 as mensagens vão ser enviadas aí eu recebo lá do outro lado a mensagem 1 a 3 a 4 e a 5 se você percebe aí eu perdi uma mensagem aí no meio tá porque porque eu escolhi essa forma de configuração At Most Once a gente tem a melhor performance mas ele pode perder algumas mensagens no meio dessa história por outro lado Novamente, o Kafka tem outros formatos pra você trabalhar. Um outro formato pra ele trabalhar é chamado de at least once. O at least once ele tem uma performance moderada e ele pode chegar a duplicar mensagens. Como assim? O at least é pelo menos né? Então o once é uma vez. Então pelo menos uma vez eu garanto que eu vou entregar a mensagem. Mas é pelo menos. Isso significa pode ser que vá mais que uma vez. Então o que acontece? Eu tenho a mensagem aqui no Kafka E a mensagem vai lá. A mensagem 1, a mensagem 2, a 3, a 4, a 4 e a 5. Ou seja, a mensagem 4 duplicou aqui. Nesse caso, o que você tem que tomar cuidado, na realidade, é no seu sistema, principalmente ali no seu consumidor, Você ter mecanismos de saber que a mensagem com aquele ID, né, ou com aquela situação, ela já foi processada. Se você lê ela de novamente, se chama, opa, já foi, deixa eu ignorar. tá então você consegue ganhar uma boa performance e você garante que você não vai perder mensagem por outro lado se vier mensagem a mais você tem que garantir tá que você não vai processar duas vezes então você vai receber e vai saber que o seu programa vai ter que excluir essa duplicação aí pra gente legal e a gente tem Uma outra situação que a gente chama de Exactly Once, tá? Que tem a pior performance e que significa exatamente uma vez, tá? E quando a gente fala exatamente uma vez, é basicamente, eu mandei a mensagem de um lado, um, dois, três, quatro, cinco. Opa, era pra ser 5 ali pessoal, tá? Eu juro pra vocês, tá? Então era pra ser 1, 2, 3, 4 e 5. Mas o grande ponto é que com uma vez apenas enviado, o Kafka, ele fica meio que, não digo malucão, mas ele fica ali pensando. Opa, será que não teve duplicação? é deixa eu garantir a mensagem chegou é igual a essa tá na ordem certa então ele tem que trabalhar com diversas formas tá para garantir que eu consumidor nunca vou receber uma mensagem duplicada ou eu consumidor nunca vou receber né vou perder uma mensagem na hora que ela for trabalhar então esse é o melhor dos mundos mas já deve dar para saber que é a nossa pior performance em relação a isso. Então a gente tem essas situações ainda em relação à parte de entrega. Então olha só quanta coisa que a gente não consegue customizar, parametrizar e que a gente tem que ter conhecimento para você conseguir tomar as melhores decisões na hora que você está trabalhando para um projeto. Afinal de contas cada projeto é um projeto e eu espero que você tome a melhor decisão Mas pra isso você tem que entender esses principais fundamentos. Maravilha? Ainda no próximo vídeo a gente vai continuar falando sobre produtores, sobre producers. Vamos nessa!