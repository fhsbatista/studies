Bom pessoal, tudo bem? No vídeo anterior a gente entendeu um pouco melhor sobre a anatomia do tópico, a gente entendeu melhor sobre o registro e a gente entendeu também um dos principais conceitos que você tem que manjar sobre o Kafka que é referente às partições, legal? Porém, o que que acontece? Existe um efeito colateral quando a gente está trabalhando com partições. E esse efeito colateral, principalmente, é como que eu consigo garantir a ordem das mensagens. E para isso, inclusive, as keys vão nos ajudar. Então, a gente vai falar um pouco sobre as keys e ao mesmo tempo abordar esse ponto que eu tô falando para vocês em relação às partições, legal? Então vamos lá. Seguinte, sobre as keys aqui. Vamos imaginar o seguinte. Eu tenho a partição 1 e eu tenho um consumidor 1, que é um cara que tá meio lento, legal? Eu tenho a partição 2 e um consumidor 2, que ele é mais rapidão. Eu tenho a partição 3, legal. E um consumidor aqui... Era pra ser consumidor 3, tá? Mas, ok. Acho que deu pra você pegar, né? Então, o que acontece é o seguinte. Cada consumidor vai começar aqui a ler de uma determinada partição. Ah, lembrei, tá? Por que eu coloquei. Eu tô querendo dizer aqui que o consumidor 2, ele pode tá lendo de duas partições, tá? Porque, às vezes, eu tenho mais partições do que consumidor. Então, o que vai acontecer? Um consumidor vai ter que ler mais do que uma partição. Legal? Mas, ok. Vamos imaginar que a gente tem essa situação aqui com a gente. Aí, a gente tem a seguinte situação. Vamos lá. Eu tenho a mensagem A, tenho a mensagem B, tenho a mensagem C, mensagem D, aqui pra mim. Aí, eu enviei a mensagem, ela caiu na partição 1. Legal? E aí quando ela cai na partição 1, ela vira ali o offset 0. Mandei a mensagem B, ela caiu na partição 2 e virou o offset 0 aqui também. Mandei a mensagem C, caiu na partição 3, offset 0 também. Aí mandei a mensagem D, caiu na partição 1, virou o offset 1 aqui pra mim. Legal? Até aí tudo bem, tudo muito lógico. Mas olha só que interessante. Vamos imaginar agora que eu tenha uma situação que é uma transferência bancária. Legal? Então vamos imaginar que a mensagem 0 que eu mandei para a partição 1 é a transferência bancária, de uma conta bancária para outra, por exemplo. A mensagem de transferência bancária é a mensagem 0 da partição 1. Aí o que que acontece? Deu algum erro no processamento. E aí a gente recebeu uma mensagem de processamento de estorno. E essa mensagem do estorno caiu na partição 2, na mensagem 0 ali, né? 970. Qual que é o grande problema? O consumidor 1, ele tá lento. E o consumidor 2, ele tá rápido. O que isso significa? A gente tem a chance do consumidor 2 consumir o evento do estorno antes da transferência ser consumida. E não faz nenhum sentido, vai dar um super rolo. Por quê? Porque em determinadas situações a ordem dos eventos e a ordem do processamento dos eventos precisam ser seguidas. Ou seja, primeiro eu faço a transferência e depois o storm. Não há possibilidade de eu tentar estornar antes de fazer uma transferência. E dessa forma que tá aqui, a gente realmente tem esse problema. Por quê? Porque a gente tem o efeito colateral que as partições elas acabam nos dando. Legal? Porque cada mensagem vai pra uma partição e a gente tem esse tipo de problema. Legal? Então isso aqui é um ponto importante de você entender. Agora, o que acontece? Olha só que interessante. Vamos imaginar, agora, que a gente teve esse problema e isso não pode acontecer, a seguinte situação aqui. Olha só que interessante. Eu falo o seguinte. A transferência que eu faço tem que estar no offset zero. e o storno tem que estar no offset 1. É a única forma que tem de a gente conseguir garantir a ordem. Ou seja, a forma que a gente tem de garantir a ordem, nesse caso, utilizando o Kafka, é fazendo com que tanto a mensagem de transferência como a mensagem do storno, elas vão para a mesma partição. Se elas forem para a mesma partição, Não tem problema, porque o consumidor, mesmo ele estando lento, primeiro ele vai ler a transferência, depois ele vai ler o estorno. Não tem perigo de um outro cara ler o estorno antes da transferência. Por quê? Porque as mensagens elas estão na mesma partição. Então, é muito claro aqui pra você. Só dá para você garantir a ordem das mensagens dentro da partição. Não tem como você garantir a leitura, a ordem das mensagens das leituras, em diversas partições. Wesley, mas como que a gente resolveria então pra garantir que tanto a transferência quanto o estorno caíssem exatamente na mesma partição? E aí eu acho que você já deve tá começando a imaginar. Que são as nossas queridas keys legal como é que funciona toda vez que eu mandar uma mensagem eu falo que a mensagem da transferência que a mensagem zero eu falo que aqui dela é igual a movimentação e quando eu mandar a mensagem storm que a mensagem 1 aqui a mensagem 1 eu falo que aqui dela é movimentação o Kafka vai falar opa todas as mensagens que estão com a mesma Eu vou mandar sempre para a mesma partição. E daí a gente resolve esse problema. Quando eu quero garantir a ordem, eu uso a mesma key para as mensagens que tem que estar em ordem. Quando eu não preciso ter a ordem, eu não preciso nem formar nenhuma key. Porque daí ele vai fazer isso de forma randômica e não tem problema nenhum. Eu vou ter diversos consumidores lendo e tá tudo ok. mas quando eu preciso eu utilizo as keys e as keys elas vão garantir com que as mesmas mensagens elas cheguem sempre na mesma ordem porque vão estar na mesma partição. Então eu vou mandar a transferência, eu crio uma key lá chamada movimentação e naquele registro lá na hora que a gente manda a mensagem eu falo qual que é o header, vai ter header? Qual que é a key? Movimentação. Qual que é a mensagem? Transferência. E a outra? Qual que é a key? Movimentação. Qual que é a mensagem? É o storno. Beleza. duas keys iguais sempre vão cair na mesma partição e daí eu posso ter paz de espírito que eu não vou ter perigo de ler mensagem fora de ordem aqui pra mim, legal? realmente é bem bacana e... essa parada de keys acaba complicando um pouco a cabeça de muita gente porque ainda há dúvidas normalmente de pra que que realmente eu preciso de uma partição, né? Não é frescura? Bota tudo numa partição só e beleza. Mas quando você entende a ideia que o Kafka tem por trás e o porquê que ele consegue escalar, exatamente nesse fato que eu acabei de te falar. Simplesmente ele consegue agir muito rápido porque ele distribui as partições, as suas mensagens, para que vários consumidores consigam ler ao mesmo tempo. Maravilha? Um grande abraço e até o nosso próximo vídeo.