# Conceitos
## O que é arquitetura orientada à eventos?
É uma arquitetura em que seus componentes esperam "eventos" para executar algo.

## Eventos
São efeitos colaterais. Podem ser muito simples ou muito complexos. Por exemplo, a contratação de um emprestimo ou uma mudança de email num cadastro.

Exemplos:
 - Porta de uma geladeira abriu. Um sistema que observa esse tipo de evento, pode decidir ligar a luz interna da geladeira.

### Escopo
Temos dois tipos de eventos: internos e externos.

Os internos são eventos consumidos por componentes que fazem parte do mesmo software que emitiu esse evneto.
Os externos, é quando os consumers estão fora desse software.

### Domain events
Tipo de evento que sinaliza algum acontecimento na camada de regras de negócio, ou seja, no nível da aplicação. Normalmente vai indicar regras de negócio. É diferente de eventos de conexão com banco de dados por exemplo, que está mais associado a algo de infra.

### Tipos de eventos
#### Event notification
É o tipo mais curto de evento. A ideia dele é ser leve, apenas transmitindo o que mudou sem dar muitos detalhes.

Ex:
 - um serviço de status de pedidos envia uma notificação dizendo que o status de um pedido mudou. Apenas passando o id, sem dar detalhes.
```json
{
    "pedido-id": 1,
    "status": "aprovado"
}
```

Esse tipo de evento é muito importante para otimizar troca de mensagens numa rede de muitos serviços, assim diminuindo o tráfego na rede.

#### Event carried state transfer
Normalmente usado em streaming de dados (ex: kafka).
Esse, diferente do anterior, tem a ideia de transmitir as informações de maneira completa.
Nesse caso, normalmente não é usado o sistema padrão de mensageria.

Nessas situações, como a intenção não é apenas comunicar algo que aconteceu, mas trasmitir o dado de maneira completa, trabalhamos com "stream de dados". 

Ex:
```json
{
  "event": "order_created",
  "order_id": "123456",
  "customer_id": "987654",
  "items": [
    {
      "product_id": "abc123",
      "name": "Produto X",
      "quantity": 2,
      "price": 19.99
    },
    {
      "product_id": "xyz789",
      "name": "Produto Y",
      "quantity": 1,
      "price": 29.99
    }
  ],
  "total_amount": 69.97,
  "currency": "BRL",
  "created_at": "2025-03-24T15:30:00Z"
}
```

Esse tipo de evento tem um custo bem mais alto, pois:
 - aumenta o tráfego na rede
 - sistema de streaming sao mais caros
 - processamento desses payloads é maior

O mais comum, é trabalhar mais com event notifications. Esse tipo mais completo é usado em casos mais específicos.

#### Event sourcing
A ideia desse tipo de evento é criar uma "linha do tempo".
O exemplo mais comum disso é transações bancárias, que são usadas pra calcular o saldo de uma conta. O saldo não pode ser alterado, o ideal é que ele seja sempre calculado a partir das transações, pois quando vamos contestar o saldo com o banco, nós contestamos uma transação, não o saldo.

##### Replay
Esses eventos normalmente são armazenados num banco de dados "time series" (ex: prometheus), que são bancos que armazenam os dados em um formato de linha do tempo.

Tendo esses dados armazenados, temos a opção de dar "replay" nesses events. Isso pode ser muito útil quando por exemplo precisamos mudar uma regra de negócio e fazer com que todos os eventos sejam processados novamente por esse regra de negócio atualizada. Isso é algo que não teria como ser feito sem essa estrutura de event sourcing.

##### Auditoria
Esse tipo de eventos pode ser muito útil pra auditoria, pois temos a linha do tempo completa do que aconteceu.

##### Retenção
Ao usar um kafka por exemplo pra trafegar esses eventos, temos que lidar com a retenção deles.
No kafka, a retenção pode ser configurável, mas não dá pra deixar no kafka pra sempre. Então precisamos de estratégias para pegar os eventos mais antigos e colocar num outro banco de dados.

O que dá pra ser feito é colocar no s3 por exemplo, mas talvez isso seja um pouco perigoso dado que os eventos pdoem acabar sendo perdidos, talvez modificados etc.

Uma ferramenta interessante são os "book keepers", que basicamente pega um conjunto de eventos e "sela" eles num arquivo, não permitindo que seja alterado. Esse arquivo podemos salvar no s3 e ficar mais seguros.




